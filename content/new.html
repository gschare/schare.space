<title>New Tab</title>
<script>
    // always default to dark mode, but do not modify the local storage variable.
    // Reusing code from the script in the header template...
    document.body.classList.add('dark-mode');
    document.getElementById('dark-mode-button').innerHTML = "‚òÄÔ∏è";
    document.getElementById('dark-mode-button').title = "Light mode";
</script>
<!-- TODO: redo this where the links themselves are part of the local browser storage & editable -->

<dialog id="editDialog">
  <form method="dialog">
    <label>Text:</label>
    <input id="itemText" required>
    <label>Link:</label>
    <input id="itemLink" required>
    <menu>
      <button value="cancel" formmethod="dialog">Cancel</button>
      <button value="ok">OK</button>
    </menu>
  </form>
</dialog>

<div class="container">
    <section class="left">
        <div id="search-bar">
            <h2> <span id="Van_Nuys_z14e" style="display: block; min-height: 1.5em"></span> </h2>

            <form action="https://duckduckgo.com/">
              <input id="search" type="search" placeholder="Search..." name="q" autofocus>
            </form>
        </div>

        <div class="lists-grid-container" id="lists">
        </div>

        <button class="add-list">+</button>

        <div id="time-and-weather">
            <div>
                <code>
                LAX üå¥: <span id="Los_Angeles_z14e"></span><br>
                UTC üïó: <span id="UTC_za00"></span><br>
                NYC üóΩ: <span id="New_York_z161"></span> <br>
                IST üáπüá∑: <span id="Istanbul_z710"></span> <br>
                </code>
                <a href="https://time.is/" id="time_is_link" rel="nofollow">Get the time at Time.is!</a>
                <script src="//widget.time.is/en.js"></script>
                <script>
                time_is_widget.init({
                    UTC_za00 : {},
                    Los_Angeles_z14e:{},
                    New_York_z161:{},
                    Istanbul_z710:{},
                    Van_Nuys_z14e:{template:"DATE", date_format:"dayname, monthname dnum, year"}
                });
                </script>
            </div>

            <div>
                <iframe src="https://wttr.in/?0q" title"Weather in current location"></iframe>
                    <br>
                Source: <a href="https://wttr.in/">wttr.in</a>
            </div>
        </div>
    </section>

<script>
const listsContainer = document.getElementById('lists');
const dialog = document.getElementById('editDialog');
const itemText = document.getElementById('itemText');
const itemLink = document.getElementById('itemLink');

let currentList = null;
let editingItem = null;

function populateLinks() {
    const listsJson = localStorage.getItem('links');
    if (!listsJson) return;
    const lists = JSON.parse(listsJson);
    for (let l of lists) {
        const ul = createList();
        for (let link of l) {
            ul.appendChild(createItem(link.text, link.link));
        }
    }
}

populateLinks();

function saveLinks() {
    const uls = listsContainer.querySelectorAll('ul');
    let newLinks = [];
    for (let ul of uls) {
        let newList = [];
        for (let a of ul.querySelectorAll('li a')) {
            newList.push({link: a.href, text: a.textContent});
        }
        if (newList.length) newLinks.push(newList);
    }
    localStorage.setItem('links', JSON.stringify(newLinks));
}

function createList() {
    const div = document.createElement('div');
    div.className = 'link-list-container';
    const ul = document.createElement('ul');
    div.appendChild(ul);

    const addButton = document.createElement('button');
    addButton.textContent = '+';
    addButton.className = 'add-item';
    addButton.onclick = () => openAddDialog(ul);
    div.appendChild(addButton);
  
    listsContainer.appendChild(div);

    return ul;
}

function openAddDialog(ul) {
    currentList = ul;
    editingItem = null;
    itemText.value = '';
    itemLink.value = '';
    dialog.showModal();
}

function openEditDialog(li, text, link) {
    editingItem = li;
    itemText.value = text;
    itemLink.value = link || '';
    dialog.showModal();
}

function createItem(text, link) {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.textContent = text;
    a.href = link || '#';
    li.appendChild(a);

    const controls = document.createElement('div');
    controls.className = 'controls';

    const editBtn = document.createElement('button');
    editBtn.textContent = '‚úé';
    editBtn.onclick = () => openEditDialog(li, text, link);

    const upBtn = document.createElement('button');
    upBtn.textContent = '‚Üë';
    upBtn.onclick = () => {li.previousElementSibling && li.parentNode.insertBefore(li, li.previousElementSibling); saveLinks();}

    const downBtn = document.createElement('button');
    downBtn.textContent = '‚Üì';
    downBtn.onclick = () => {li.nextElementSibling && li.parentNode.insertBefore(li.nextElementSibling, li); saveLinks();}

    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóë';
    delBtn.onclick = () => {li.remove(); saveLinks();}

    controls.append(editBtn, upBtn, downBtn, delBtn);
    li.appendChild(controls);

    return li;
}

// Listener to apply changes
dialog.addEventListener('close', () => {
  if (dialog.returnValue !== 'ok') return;

  const text = itemText.value.trim();
  const link = itemLink.value.trim();

  if (editingItem) {
    // Editing an item
    const a = editingItem.querySelector('a');
    a.textContent = text;
    a.href = link || '#';
  } else if (currentList) {
    // Creating new item
    currentList.appendChild(createItem(text, link));
  }
  saveLinks();
});

document.querySelector('.add-list').addEventListener('click', createList);
</script>

    <!-- notepad 
        source: https://blog.jverkamp.com/2018/09/26/simple-localstorage-notepad/
    -->
    <section class="right">
        <div>
            <p>Not enough space? Need to focus? <a href="/lab/box.html">Put it in the box!</a> <input type="button" class="anchor-button" id="editor-toggle" value="Hide"></input></p>
            
            <textarea id="editor" contenteditable="true" placeholder="Type..."></textarea>
            <script>
            (function() {
                var editorKey = 'html5-notepad';
                var editor = document.getElementById('editor');
                var cache = localStorage.getItem(editorKey);

                if (cache) {
                    editor.value = cache;
                }

                function autosave() {
                    var newValue = editor.value;
                    if (cache != newValue) {
                        cache = newValue;
                        localStorage.setItem(editorKey, cache);
                    }
                }

                editor.addEventListener('input', autosave);

                // Only fires in other windows. Ensures nothing gets out of date.
                window.addEventListener('storage', (e) => {
                  if (e.key === editorKey) {
                    console.log('editor changed in another tab:', e.newValue);
                    editor.value = e.newValue;
                  }
                });

                var editorToggle = document.getElementById('editor-toggle');

                const editorToggleStateKey = 'editor-hidden';
                var editorHidden = localStorage.getItem(editorToggleStateKey) === 'hidden'; // localStorage values are only strings

                function applyEditorToggleState() {
                    editorToggle.value = editorHidden ? "Show" : "Hide";
                    if (editorHidden) {
                        editor.classList.add('hidden');
                    } else {
                        editor.classList.remove('hidden');
                    }
                }

                function toggleEditor() {
                    editorHidden = !editorHidden;
                    localStorage.setItem(editorToggleStateKey, editorHidden ? 'hidden' : 'shown');
                    applyEditorToggleState();
                }

                applyEditorToggleState();

                editorToggle.addEventListener('click', (e) => {
                    toggleEditor();
                });
            })();
            </script>
            <p>Parallel play with the wind.</p>
        </div>
    </section>
</div>
