<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<title>Po(st)mo(dernism)doro</title>
<style>
* {
    transition: background 0.2s ease;
}

body.pomo {
    background-color: #1c282f;
}

body.pause {
    background-color: #2c2d2e;
}

body.pomo, body.pause {
    color: white;
}

body.done {
    background-color: #ffcffc;
}

.col {
    padding-right: 30px;
}

.app {
    min-height: 80vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    /*gap: 1.25rem;*/
    font-family: system-ui, sans-serif;
    margin: 0;
}

#timer {
    font-size: 3rem;
    font-variant-numeric: tabular-nums;
    margin-top: 1.25rem;
}

.modes {
    display: flex;
    gap: 0.5rem;
}

.controls {
    display: flex;
    gap: 0.75rem;
}

button {
    background: none;
    border: 1px solid #555;
    padding: 0.4rem 0.8rem;
    font-size: 1rem;
    cursor: pointer;
}

body.pomo button, body.pause button {
    border-color: #ccc;
    color: white;
}

button.active {
    background: #222;
    color: white;
    border-color: #222;
}

.controls button {
    font-size: 3rem;
    border: none;
}

.controls button#reset {
    transform: translateY(-10%); /* to match vertically with play/pause button */
}

body.pomo button.active, body.pause button.active {
    background: white;
    color: #222;
    border-color: white;
}

.progress {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #222;
    transition: background 0.2s ease;
}

.dot.active {
    background: #fffad5; /* a little brighter & paler in day */
    box-shadow: 0 0 4px rgba(255,247,176,1); /* smaller but more intense glow in day */
}

body.pomo .dot.active, body.pause .dot.active {
    background: #fff178; /* a little warmer at night */
    box-shadow: 0 0 10px rgba(255,247,176,0.3); /* larger but less intense glow at night */
}

.progress.reset-armed .dot {
    background: #bbb;
}

.progress.reset-armed .dot.active {
    background: #ff4a3a;
    box-shadow: 0 0 4px rgba(255,75,75,0.7);
}

body.pomo .progress.reset-armed .dot, body.pause .progress.reset-armed .dot {
    background: #888;
}

body.pomo .progress.reset-armed .dot.active, body.pause .progress.reset-armed .dot.active {
    background: #fb4242;
    box-shadow: 0 0 6px rgba(251,66,66,0.35);
}

header {
    display: none;
}
</style>

<div class="app">
    <div class="modes">
        <button data-mode="focus">Focus</button>
        <button data-mode="shortBreak">Short Break</button>
        <button data-mode="longBreak">Long Break</button>
    </div>
    <div id="timer">25:00</div>
    <div class="controls">
        <button id="playpause" onclick="toggle()">&#x23F5;</button>
        <button id="reset">&#8634;</button>
    </div>
    <div class="progress">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>
</div>

<script>
    const DURATIONS = { focus: 25*60, shortBreak: 5*60, longBreak: 20*60 };
    let mode = 'focus'; // 'focus', 'shortBreak', 'longBreak'
    let seconds = DURATIONS.focus;
    let interval = null;
    let pomodoroCount = 0;
    let shift = false;
    let hadLongBreak = false;

    function saveState() {
        localStorage.setItem("pomodoroState", JSON.stringify({
            mode,
            seconds,
            pomodoroCount
            //running
        }));
    }

    function loadState() {
        const saved = localStorage.getItem("pomodoroState");
        if (!saved) return;
        const state = JSON.parse(saved);
        mode = state.mode;
        seconds = state.seconds;
        pomodoroCount = state.pomodoroCount;
        //running = state.running;
    }

    function updateDisplay() {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById("timer").textContent =
          String(mins).padStart(2, "0") + ":" +
          String(secs).padStart(2, "0");
        document.querySelectorAll(".modes button").forEach(btn => {
            btn.classList.toggle("active", btn.dataset.mode === mode);
        });
    }

    function stop() {
        clearInterval(interval);
        interval = null;
        document.getElementById('playpause').textContent = '\u23F5';
    }

    function toggle() {
        if (interval) {
            document.body.classList.remove('done');
            document.body.classList.add('pomo');
            document.body.classList.add('pause');
            stop();
        } else {
            interval = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    finishPhase();
                }
                updateDisplay();
            }, 1000);

            document.getElementById('playpause').textContent = '\u23F8';
            document.body.classList.remove('done');
            document.body.classList.remove('pause');
            document.body.classList.add('pomo');
        }
        saveState();
    }

    function finishPhase() {
        stop();
        document.body.classList.remove('pomo');
        document.body.classList.remove('pause');
        document.body.classList.add('done');
        if (mode === "longBreak") hadLongBreak = true;
        if (mode === "focus") {
            pomodoroCount++;
            hadLongBreak = false;
            mode = (pomodoroCount % 4 === 0) ? "longBreak" : "shortBreak";
        } else {
            mode = "focus";
        }
        seconds = DURATIONS[mode];
        saveState();
        updateProgress();
    }

    function updateProgress() {
        const dots = document.querySelectorAll(".dot");
        let lit = pomodoroCount % 4;
        if (pomodoroCount === 4 && !hadLongBreak) lit = 4;
        /* Worth explaining how this works.
         * You're allowed to change modes whenever you want, but the lights at
         * the bottom are basically encouragement to actually follow the method
         * and work up to the long break. The lights track how close you are to
         * a long break, remind you to take it if you see all four lit up, and
         * if you're in a long break they will stay on while in the break as a
         * little visually satisfying reward to show you actually worked up to
         * it. Only once you actually take the long break will the lights
         * disappear, or if you finish another focus block. You can reset your
         * progress by shift-clicking the reset button. Of course you can also
         * just update things manually in the console.
         */
       
        dots.forEach((dot, i) => {
            dot.classList.toggle("active", i < lit);
        });
     }

    function reset() {
        clearInterval(interval);
        interval = null;
        document.getElementById('playpause').textContent = '\u23F5';
        document.body.classList.remove('pomo');
        document.body.classList.remove('pause');
        document.body.classList.add('done');
        seconds = DURATIONS[mode];
        updateDisplay();
        saveState();
    }

    document.querySelectorAll(".modes button").forEach(btn => {
        btn.addEventListener("click", () => {
            console.log('btn');
            stop();
            document.body.classList.remove('pomo');
            document.body.classList.remove('pause');
            document.body.classList.add('done');
            mode = btn.dataset.mode;
            seconds = DURATIONS[mode];
            saveState();
            updateDisplay();
            updateProgress();
        });
    });

    document.addEventListener("keydown", e => {
        if (e.code === "Space") {
            e.preventDefault();
            toggle();
        }
    });

    const resetButton = document.getElementById("reset");
    const progress = document.querySelector(".progress");

    document.addEventListener("keydown", e => {
        if (e.key === "Shift") {
            shift = true;
            if (resetButton.matches(":hover")) {
                progress.classList.add("reset-armed");
            }
        }
    });

    document.addEventListener("keyup", e => {
        if (e.key === "Shift") {
            shift = false;
            progress.classList.remove("reset-armed");
        }
    });
    
    resetButton.addEventListener("mouseenter", () => {
        if (shift) progress.classList.add("reset-armed");
    });
    
    resetButton.addEventListener("mouseleave", () => {
        progress.classList.remove("reset-armed");
    });

    resetButton.addEventListener("click", (e) => {
        if (e.shiftKey) {
            pomodoroCount = Math.floor(pomodoroCount / 4) * 4;
            saveState();
            updateProgress();
            progress.classList.remove("reset-armed");
        } else {
            reset();
        }
    });

    loadState();
    updateProgress();
    updateDisplay();
    document.body.classList.add('done');

  </script>
</body>
</html>
